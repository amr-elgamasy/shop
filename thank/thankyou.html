<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>شكراً لطلبك | متجرنا</title>
  <link rel="stylesheet" href="thank.css">
</head>
<body>
  <div class="thank-you-container">
    <div class="thank-you-card">
      <div id="loading" style="display: none;" class="loading-indicator">
        <div class="spinner"></div>
        <p>جاري إرسال بيانات طلبك...</p>
      </div>

      <div id="success-content">
        <div class="checkmark-circle">
          <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
            <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
          </svg>
        </div>
        
        <h1>شكراً لطلبك!</h1>
        <p class="thank-you-message">
          لقد تم استلام طلبك بنجاح وسيتم تجهيزه في أقرب وقت ممكن. 
          <br>سنقوم بإرسال تفاصيل الشحن وتتبع الطلب على رقم هاتفك.
        </p>
        
        <div class="order-details">
          <div class="detail-row">
            <span class="detail-label">رقم الطلب:</span>
            <span class="detail-value">#<span id="order-number">--</span></span>
          </div>
          <div class="detail-row">
            <span class="detail-label">تاريخ الطلب:</span>
            <span class="detail-value" id="order-date">--</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">طريقة الدفع:</span>
            <span class="detail-value" id="payment-method">--</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">المجموع الكلي:</span>
            <span class="detail-value total-amount" id="total-amount">--</span>
          </div>
        </div>
        
        <div class="whats-next">
          <h2>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            ما هي الخطوات التالية؟
          </h2>
          <ul class="next-steps">
            <li>سيتم مراجعة طلبك وتجهيزه خلال 24-48 ساعة</li>
            <li>ستتلقى رسالة تأكيد عند شحن الطلب</li>
            <li>يمكنك تتبع حالة الطلب من خلال الرابط المرفق في الرسالة</li>
            <li>سيتم توصيل الطلب خلال 2-5 أيام عمل</li>
          </ul>
        </div>
        
        <div class="action-buttons">
          <!-- زر طباعة الطلب -->
          <button onclick="printOrder()" class="btn btn-primary" style="background: var(--success-color)">
            <i class="fas fa-print" style="margin-left: 8px;"></i>
            طباعة الطلب
          </button>

          <!-- زر واتساب -->
          <a href="https://wa.me/966500000000" class="btn btn-whatsapp">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-left: 8px;">
              <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
            </svg>
            تواصل معنا عبر واتساب
          </a>
          <!-- زر العودة للتسوق -->
          <a href="../product/products.html" class="btn btn-outline" style="margin-top: 10px; width: 100%;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-left: 8px;">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            العودة للتسوق
          </a>
        </div>
        
        <div class="contact-info">
          لأي استفسارات، لا تتردد في <a href="mailto:support@example.com">مراسلتنا عبر البريد الإلكتروني</a> 
          أو الاتصال على <a href="tel:+966500000000">٠٥٠٠٠٠٠٠٠٠</a>
        </div>
      </div>

      <div id="error-message" style="display: none;" class="error-message">
        <p id="error-text">عذراً، حدث خطأ أثناء معالجة طلبك. الرجاء المحاولة مرة أخرى أو التواصل معنا.</p>
      </div>
    </div>
  </div>

  <!-- أنماط إضافية -->
  <style>
    /* تنسيق صفحة الطباعة */
    @media print {
      body * {
        visibility: hidden;
      }
      .thank-you-card, .thank-you-card * {
        visibility: visible;
      }
      .thank-you-card {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
      .action-buttons, .whats-next {
        display: none !important;
      }
      .order-details {
        border: 1px solid #ddd;
        padding: 15px;
        margin: 20px 0;
      }
    }

    /* تنسيقات إضافية */
    .thank-you-card {
      position: relative;
      overflow: hidden;
    }

    .thank-you-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        45deg,
        transparent 0%,
        rgba(50, 173, 150, 0.05) 30%,
        transparent 60%
      );
      animation: shimmer 4s infinite linear;
      z-index: -1;
    }

    @keyframes shimmer {
      0% { transform: translateX(-30%) translateY(-30%) rotate(0deg); }
      100% { transform: translateX(-30%) translateY(-30%) rotate(360deg); }
    }

    .btn-whatsapp {
      background: #25D366;
      color: white;
      border: none;
      width: 100%;
      margin-top: 10px;
    }

    .btn-whatsapp:hover {
      background: #128C7E;
    }

    .order-details {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px dashed rgba(0,0,0,0.1);
    }

    .detail-row:last-child {
      border-bottom: none;
    }
    .loading-indicator {
      text-align: center;
      margin: 20px 0;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      margin: 0 auto 15px;
      animation: spin 1s linear infinite;
    }

    .error-message {
      background-color: #fff5f5;
      color: #e53e3e;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
      border: 1px solid #fed7d7;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <script>
    // دالة طباعة الطلب
    function printOrder() {
      window.print();
    }
    // تعريف طرق الدفع
    const paymentMethods = {
      'cash': 'الدفع عند الاستلام',
      'wallet': 'المحافظ الإلكترونية',
      'visa': 'بطاقة فيزا / ماستركارد'
    };

    document.addEventListener('DOMContentLoaded', function () {
      const loading = document.getElementById('loading');
      const successContent = document.getElementById('success-content');
      const errorMessage = document.getElementById('error-message');
      const errorText = document.getElementById('error-text');

      async function processOrder() {
        try {
          loading.style.display = 'block';
          successContent.style.display = 'none';
          errorMessage.style.display = 'none';

          const orderNumber = localStorage.getItem("order_number");
          const orderData = JSON.parse(localStorage.getItem("checkout_data") || "{}");
          
          if (!orderData || !orderNumber) {
            throw new Error('بيانات الطلب غير متوفرة');
          }

          // تنسيق التاريخ بشكل أفضل
          const timestamp = new Date().toLocaleString('ar-EG', {
            year: 'numeric',
            month: 'numeric',
            day: 'numeric',
            hour: 'numeric',
            minute: 'numeric',
            hour12: true
          });

          // تجهيز البيانات للإرسال للشيت
          const serverData = {
            action: 'checkAndUpdateQuantity',
            contents: {
              order: {
                number: orderNumber,
                timestamp: timestamp,
                customer_name: orderData.name,
                phone: orderData.phone,
                address: orderData.address,
                payment_method: orderData.payment_method,
                products: JSON.stringify(orderData.products),
                total_amount: orderData.total_amount,
                notes: orderData.notes || 'لا يوجد'
              },
              products: orderData.products.map(item => ({
                id: item.id,
                quantity: item.quantity
              }))
            }
          };

          // تسجيل أكثر تفصيلاً للبيانات
          console.log('=== بداية معالجة الطلب ===');
          console.log('بيانات الطلب:', orderData);
          console.log('البيانات المرسلة للسيرفر:', serverData);
          console.log('طريقة الدفع المختارة:', paymentMethods[orderData.payment_method]);

          // إرسال البيانات للشيت
          const formData = new URLSearchParams();
          formData.append('data', JSON.stringify(serverData));

          // إرسال البيانات إلى جوجل شيت
          const sheetResponse = await fetch('https://script.google.com/macros/s/AKfycbx25K95DTNH7oziuub4qGxMY6boKEiJrkJFoVSH2R464NSdC025KoiL8qdUiAPoLEwM/exec', {
            method: 'POST',
            mode: 'no-cors',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: formData.toString()
          });

          // تجهيز رسالة تليجرام
          const productsText = orderData.products.map(item =>
            `المنتج: ${item.name}\nالكمية: ${item.quantity}\nالسعر: ${item.price} ج.م`
          ).join('\n\n');

          // تحويل طريقة الدفع للعربية

          const message = `🛍️ طلب جديد!\n\n` +
            `رقم الطلب: ${orderNumber}\n` +
            `التاريخ: ${timestamp}\n\n` +
            `👤 بيانات العميل:\n` +
            `الاسم: ${orderData.name}\n` +
            `الهاتف: ${orderData.phone}\n` +
            `العنوان: ${orderData.address}\n\n` +
            `🛒 المنتجات:\n${productsText}\n\n` +
            `💰 المبلغ الإجمالي: ${orderData.total_amount} ج.م\n` +
            `💳 طريقة الدفع: ${paymentMethods[orderData.payment_method] || orderData.payment_method}\n` +
            `📝 ملاحظات: ${orderData.notes || 'لا يوجد'}`;

          // إرسال الإشعار إلى تليجرام
          const telegramResponse = await fetch(`https://api.telegram.org/bot7640824940:AAFZyK7kuzFa5CJSJzvte6xhe_ATBFw53G4/sendMessage`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              chat_id: '5773416612',
              text: message,
              parse_mode: 'HTML'
            })
          });

          if (!telegramResponse.ok) {
            console.error('فشل في إرسال الإشعار إلى تليجرام');
          } else {
            console.log('تم إرسال الإشعار إلى تليجرام بنجاح');
          }
          
          console.log('=== نهاية معالجة الطلب ===');

          // عرض تفاصيل الطلب
          document.getElementById('order-number').textContent = orderNumber;
          document.getElementById('order-date').textContent = timestamp;

          // تم نقل تعريف paymentMethods إلى أعلى
          document.getElementById('payment-method').textContent = paymentMethods[orderData.payment_method] || 'غير محدد';
          document.getElementById('total-amount').textContent = orderData.total_amount.toLocaleString('ar-EG') + ' ج.م';

          // إظهار المحتوى وتنظيف التخزين المحلي
          loading.style.display = 'none';
          successContent.style.display = 'block';
          
          console.log('تم تسجيل الطلب بنجاح');

          // وضع علامة لإفراغ النموذج عند العودة لصفحة الدفع
          localStorage.setItem('should_reset_form', 'true');

          // تنظيف التخزين المحلي
          localStorage.removeItem("checkout_data");
          localStorage.removeItem("cart");
          localStorage.removeItem("order_number");

        } catch (error) {
          console.error("🚨 خطأ:", error);
          loading.style.display = 'none';
          successContent.style.display = 'none';
          errorMessage.style.display = 'block';
          errorText.textContent = 'عذراً، حدث خطأ أثناء معالجة طلبك: ' + error.message;
        }
      }

      // معالجة وعرض الطلب
      processOrder();
    });
  </script>
</body>
</html>